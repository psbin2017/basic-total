# ElasticSearch

- [루씬](https://ko.wikipedia.org/wiki/%EB%A3%A8%EC%94%AC)

## 용어 사전

| Elastic Search | RDB |
| -- | --- |
| 인덱스(Index) | 데이터베이스(Database), [정확히는 다르다](https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html) |
| 샤드(Shard) | 파티션(Partition) |
| 타입(Type) | 테이블(Table), `단 SQL 테이블들은 서로 독립적` |
| 문서(Document) | 행(Row) |
| 필드(Field) | 열(Column) |
| 매핑(Mapping) | 스키마(Schema) |
| Query DSL | SQL |
| 반전된 인덱스[(Inverted Index)](https://www.elastic.co/guide/en/elasticsearch/guide/current/inverted-index.html) | 인덱스(Index) |

### NRT (Near Realtime)

> 문서를 색인화하는 시점부터 문서가 검색 가능해지는 시점까지 약간의 대기 시간(약 1초).

### 클러스터 (Cluster)

> 하나 이상의 노드(서버)의 집단.

클러스터는 고유한 이름으로 식별됨. (기본값 `elasticsearch`) 서로 다른 인프라에 다른 이름으로 명명하도록 권장함.
하나의 클러스터는 원하는 개수의 노드를 포함할 수 있음.

### 노드 (Node)

> 클러스터에 포함된 단일 서버.

노드는 데이터를 저장하고 클러스터의 색인화 및 검색 기능에 참여함. 노드는 클러스터처럼 이름으로 식별됨. (기본값 시작시 임의 UUID(Universally Unique IDentifier))

노드는 클러스터 이름을 통해 어떤 클러스터의 일부로 구성될 수 있음. 기본적으로 각 노드는 `elasticsearch` 라는 이름의 클러스터에 포함되도록 설정됨.

각각을 검색할 수 있다고 가정하고 노드가 시작할 경우, 이 노드는 모두 자동으로 `elasticsearch` 라는 단일 클러스터를 형성하고 이 클러스터의 일부가 됨. 이 때, 단일 클러스터가 없는 상태에서 노드를 실행시 단일 클러스터가 생성됨.

### 인덱스 (Index)

> 다소 비슷한 특성을 가진 문서의 모음.

색인의 이름은 모두 소문자임. 색인은 이름으로 식별되며, 이 이름은 색인에 포함된 문서에 대한 색인화, 검색, 업데이트, 삭제 작업에서 해당 색인을 가리키는 데 쓰임. 단일 클러스터에서 원하는 개수의 색인을 정의할 수 있음.
예: 고객 데이터에 대한 색인, 제품 카탈로그에 대한 색인, 주문 데이터에 대한 색인을 각각 둘 수 있음.

### 타입 (Type)

> 색인을 논리적으로 분류/구분한 것.

하나의 색인에서 하나 이상의 유형을 정의할 수 있음. 일반적으로 여러 공통된 필드를 갖는 문서에 대해 유형이 정의.

유형의 체계는 전적으로 사용자가 결정.

- 예: 블로그 플랫폼을 운영하고 있는데 모든 데이터를 하나의 색인에 저장한다고 가정하면 이 색인에서 사용자 데이터, 블로그 데이터, 댓글 데이터에 대한 유형을 각각 정의할 수 있음.

### 문서 (Document)

> 색인화할 수 있는 기본 정보 단위.

하나의 색인/유형에 원하는 개수의 문서를 저장할 수 있음. 문서가 물리적으로는 어떤 색인 내에 있더라도 문서는 색인화되어 색인에 포함된 어떤 유형으로 지정되어야 함.

예: 어떤 단일 고객, 단일 제품, 단일 주문에 대한 문서가 각각 존재할 수 있음. (데이터 포맷은 JSON)

### 샤드 (Shard) & 레플리카 (Replica)

색인은 방대한 양의 데이터를 저장할 수 있는데, 이 데이터가 단일 노드의 하드웨어 한도를 초과할 수도 있음.

- 예: 10억 개의 문서로 구성된 하나의 색인에 1TB의 디스크 공간이 필요할 경우, 단일 노드의 디스크에서 수용하지 못하거나 단일 노드에서 검색 요청 처리 시 속도가 너무 느려질 수 있다.

색인을 이른바 샤드(shard)라는 조각으로 분할하는 기능을 제공함. 색인을 생성할 때 원하는 샤드 수를 간단히 정의할 수 있음. 각 샤드는 그 자체가 온전한 기능을 가진 독립적인 "색인"이며, 클러스터의 어떤 노드에서도 호스팅할 수 있음.

샤딩은 크게 2가지가 중요함.

- 콘텐츠 볼륨의 수평 분할/확장이 가능.
- 작업을 (어쩌면 여러 노드에 위치한) 여러 샤드에 분산 배치하고 병렬화함으로써 성능/처리량을 늘릴 수 있음.

샤드가 분산 배치되는 방식 및 그 문서가 다시 검색 요청으로 집계되는 방식의 메커니즘은 모두 Elasticsearch 에서 관리.

언제든 오류가 일어날 가능성이 있는 네트워크/클라우드 환경에서는 어떤 이유에서든 샤드/노드가 오프라인 상태가 되거나 사라지게 될 경우에 대비하여 페일오버(fail over) 메커니즘을 마련하는 것이 매우 유익하고 바람직함. 이러한 취지에서 색인의 샤드에 대해 하나 이상의 복사본을 생성할 수 있는데, 이를 리플리카 샤드(replica shard), 줄여서 리플리카라고 함.

리플리카는 크게 2가지가 중요함.

- 샤드/노드 오류가 발생하더라도 고가용성을 제공. 따라서 리플리카는 그 원본인 기본 샤드와 동일한 노드에 배정되지 않음.
- 모든 리플리카에서 병렬 방식으로 검색을 실행할 수 있으므로 검색 볼륨/처리량을 확장할 수 있음.

요약하자면 각 색인은 여러 개의 샤드로 분할할 수 있다. 또한 하나의 색인은 복제하지 않거나(리플리카 없음) 1회 이상 복제할 수 있다. 복제되면 각 색인은 기본 샤드(복제 원본 샤드)와 리플리카 샤드(기본 샤드의 복사본)를 갖는다. 샤드 및 리플리카의 수는 색인별로, 색인 생성 시점에 정의할 수 있다. 색인이 생성된 다음 언제라도 탄력적으로 리플리카의 수를 변경할 수 있으나, 샤드 수는 사후 변경이 불가하다.

기본적으로 Elasticsearch 의 각 색인은 기본 샤드 5개, 리플리카 1개를 갖는다. 따라서 클러스터에 최소한 2개의 노드가 있다면 색인은 기본 샤드 5개, 리플리카 샤드 5개(완전한 리플리카 1개)를 가지므로 색인당 총 10개의 샤드가 존재하게 됨.

### 역색인

색인? 특정한 데이터가 어느 위치에 있는지 미리 알고 있어 검색시 색인 값을 통해 빠른 속도로 찾을 수 있게한다. (책갈피)

보통 데이터가 저장되면 1 번째 row 에 어떤 데이터가 있다는 식으로 저장한다. 역색인은 반대로 어떤 데이터는 몇 번째 row 에 있다는 식으로 저장한다.

> 말장난 같은데 뭐가 빠를까? **Elastic Search 의 강점은 여러 단어의 조합들이 저장될 때 나타난다.**

Elastic Search 는 데이터를 저장할 때 의미있는 단어를 추출해 해당 단어들로 역색인 값을 생성한다. 단어 검색시 어떤 데이터들에 해당 단어가 포함되어 있는지 쉽게 찾을 수 있다.

| 아이디 | 데이터 |
| --- | --- |
| 1 | 마음을 드려요 |
| 2 | 마음 |
| 3 | 봄 사랑 벚꽃 말고 |
| 4 | 봄 안녕 봄 |
| 5 | 라일락 |

| 토큰 | 아이디 |
| --- | --- |
| 마음 | 1, 2 |
| 봄 | 3, 4 |
| 사랑 | 3 |
| 벚꽃 | 3 |
| 말고 | 3 |
| 안녕 | 4 |
| 라일락 | 5 |
| 드려요 | 1 |

단어 기반 검색시 토큰 값으로 대상 문서를 쉽게 찾을 수 있다.

## 학습내용 참고 출처

- [Elasticsearch Guide](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html?baymax=KR-ES-getting-started&elektra=landing-page)
- [What is the difference between an elastic search index and an index in a relational database?](https://stackoverflow.com/questions/34539476/what-is-the-difference-between-an-elastic-search-index-and-an-index-in-a-relatio/34572470)
- [[엘라스틱서치 알아보기 #1] 엘라스틱서치는 검색엔진이다.](https://velog.io/@jakeseo_me/%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0-1-%EC%97%98%EB%9D%BC%EC%8A%A4%ED%8B%B1%EC%84%9C%EC%B9%98%EB%8A%94-%EA%B2%80%EC%83%89%EC%97%94%EC%A7%84%EC%9D%B4%EB%8B%A4)
