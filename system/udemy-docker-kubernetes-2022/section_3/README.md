# 섹션 3 데이터 관리 및 볼륨으로 작업하기

- 이미지와 컨테이너가 어떻게 데이터를 관리하는지
- 다른 폴더에 연결하는 방식
- 도커 내장 볼륨의 개념
- 인수와 환경 변수를 탐색하여 도커 이미지/컨테이너에서 이를 사용하는 방법과 사용하는 이유

## 데이터

- 애플리케이션: 우리가 작성한 코드. 이미지 기반으로 컨테이너는 제공된 환경에서 우리의 코드를 사용하며 이미지는 복사된 것이므로 우리가 작성한 코드는 고정되어있다.
- 임시 앱 데이터: 애플리케이션이 실행되면서 생성된 데이터. 사용자가 입력한 데이터가 코드의 변수로 저장되니 여기에 해당할 수 있다.
- 영구 앱 데이터 : 임시 앱 데이터 중 용도에 따라 영구적으로 저장하는 데이터. 데이터베이스나 파일 등으로 영구 저장할 수 있다. 컨테이너가 중지되어도 데이터는 있어야 한다.

### 문제점

만약 데이터를 파일로 저장했다고 하면 컨테이너가 중지되어서 삭제된다면? 볼륨을 통해 데이터를 유지하게 할 수 있다.

## 볼륨

> 볼륨은 영구적인 데이터에 적합하다.

볼륨은 익명 볼륨과 명명된 볼륨 크게 2가지 종류가 있다.

### 익명 볼륨

익명 볼륨은 컨테이너가 --rm 플래그로 제거될 때 같이 제거된다. 따라서 컨테이너를 새로 만들 때 마다 익명 볼륨이 생성되는데 사용하지 않는 익명 볼륨이 점차 쌓이게된다. `docker volume VOL_NAME` 또는 `docker volume prune` 을 통해 사용하지 않는 볼륨을 제거할 수 있다.

```Dockerfile
// 컨테이너의 외부 폴더에 매핑되어야할 컨테이너 내부 위치
// 익명 볼륨이 된다.
VOLUME [ "/app/feedback" ]
```

### 명명된 볼륨

명명된 볼륨은 영구적이기는 하나 편집하거나 직접 볼 필요가 없는 데이터일 때 유용하다. 명명된 볼륨은 Dockerfile 로 지정할 수 없고 `docker run` 시 옵션을 주어 실행할 수 있다.

`docker run -v feedback /app/feedback`

위 명령어는 명명된 `feedback` 볼륨이 생성되고 컨테이너의 `/app/feedback` 경로가 대상이된다. 기본적으로 볼륨은 도커가 관리하는 어딘가에 숨겨져 있으며 대부분 편집할 필요가 없다.

## 바인드 마운트 볼륨

> 바인드 마운트 볼륨은 영구적이면서도 **편집 가능**한 데이터에 적합하다.

레이어 단위로 실행되는 명령어에서 소스 코드의 변경점을 반영하지 않는 명령어로 작성하였다면 명령어가 레이어 캐싱되어 소스 코드가 변경되어도 수행되지 않아 코드가 변경되지 않는 등의 문제가 있다.

마운트 볼륨은 호스트 머신상 매핑될 컨테이너의 경로를 설정한다. (볼륨은 경로를 설정하지 않아 이 부분이 다르다.) **소스 코드를 바인드 마운트에 넣으면 스냅샷에 복사하는 것이 아닌 바인딩 마운트에 복사하게 된다.** 따라서 컨테이너는 항상 최신 코드에 액세스할 수 있게 된다.

`docker run ... -v "${로컬 경로}:/app"`

위 명령어는 도커가 로컬 경로에 접근할 수 있어야 한다.

### 바인드 마운트의 추가 주의사항

도커는 로컬 경로를 복사하여 컨테이너에 사용하게 되는데 용도에 따라 실행 환경을 가지는 외부 디펜던시 코드를 포함하지 않은 상태로 코드가 되어있으나 Dockerfile 을 통해 생성되거나 가져오는 파일들이 같은 경로로 포함되면 정상적으로 컨테이너가 실행되지 않을 수 있다.

이 경우 해당 경로를 별도의 익명 볼륨으로 선언하여 사용할 수 있다. 도커는 볼륨을 평가할 때 더 긴 내부 경로를 가진 볼륨을 우선시하여 먼저 평가한다.

이렇게 되면 바인드 마운트 볼륨의 결과물인 "로컬 경로" 에 추가로 "볼륨" 내용물을 덮어쓰게 된다.

1. /app 경로의 로컬 경로를 복사한다.
2. /app/node_modules 경로를 복사한다. (실제로는 없기 때문에 덮어쓰게 된다.)

## 볼륨 비교하기

- `docker run -v /app/data ...` : 익명 볼륨
- `docker run -v data:/app/data ...` : 명명된 볼륨
- `docker run -v /path/to/code:/app/code ...` : 바인드 마운트 볼륨

| 구분 | Dockerfile | --rm | 공유 |
| --- | --- | --- | --- |
| 익명 볼륨 | O | 제거됨 | 불가능 |
| 명명된 볼륨 | X | 제거 안됨 | 가능 |
| 바인드 마운트 볼륨 | X | 제거 안됨 | 가능 |

## .dockerignore

`.gitignore` 처럼 프로젝트 폴더에서 COPY 명령어로 복사하지 않아도 되는 폴더를 추가할 수 있다.

```.gitignore
Dockerfile
.git

/app/node_modules
```

## 인자와 환경변수

환경 변수는 다음과 같이 선언할 수 있다.

```Dockerfile
ENV PORT 80
```

`docker run -e port 80`

또한 `.env` 파일에 미리 선언하여 해당 파일을 사용하게끔 할 수 있다.

```.env
PORT=8080
```

### 빌드 인수

```Dockerfile
ARG DEFAULT_PORT 80
ENV PORT $DEFAULT_PORT
EXPOSE $PORT
```

`docker run --build-arg DEFAULT_PORT=8080`

`docker --env-file ./.env`

Dockerfile 에 보안 파일을 포함하지 않아야한다. 별도의 파일을 사용하는 경우 해당 파일을 커밋하지 않도록 하자.

## 컨테이너/이미지 명령어

### `docker volume`

> 볼륨에 접근할 수 있다.

- `prune` : 사용하지 않는 볼륨을 삭제한다.
- `inspect` : 볼륨의 상태를 확인한다.
- `delete` : 볼륨을 삭제한다.
- `create` : 볼륨을 생성한다.

바인드 마운트 볼륨의 경우 로컬 절대 경로를 사용할 수 도 있고 아래처럼 바로가기를 사용할 수 있다.

- macOS / Linux: `-v $(pwd):/app`
- Windows: `-v "%cd%":/app`

### `docker run -v`

> `-v ${named voulme} ${directory}` 옵션은 컨테이너에 볼륨을 추가할 수 있다.

용도에 따라 볼륨이 읽기 권한만 부여하고자 하는경우 `:ro` 를 선언하여 사용할 수 있다.

### `docker run -e`

> `-e ${key} ${value}` 는 환경 변수를 추가할 수 있다.

## ETC

- NodeJS 는 Nodemon 이라는 파일의 변경사항을 감지하는 기능이 있다.
