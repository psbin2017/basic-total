# ✨ 아이템 50: 적시에 방어적 복사본을 만들라

클라이언트로부터 클래스를 보호하는 데 충분한 시간을 투자하는게 좋다. 어떤 객체든 그 객체의 허락 없이는 외부에서 내부를 수정하는 일은 불가능하다. 하지만 주의를 기울이지 않으면 자기도 모르게 내부를 수정하도록 허락하는 경우가 생긴다.

**외부 공격으로부터 인스턴스의 내부를 보호하려면 생성자에서 받은 가변 매개변수를 각각 방어적으로 복사해야한다.** (defensive copy)

[DefensiveCopy](https://github.com/psbin2017/garbage-collection/blob/master/gc/src/test/java/com/collection/gc/sample/method/DefensiveCopy.java)

> 예제에서는 `Date` 를 사용하였는데 자바 8 이상이라면 `Instant` 혹은 `LocalDateTime` 이나 `ZonedDateTime` 을 사용하는 것이 좋다.

클래스가 불변이든 가변이든, 가변인 내부 객체를 클라이언트에 반환할 때는 반드시 심사숙고해야한다. 안심할 수 없다면 방어적 복사본을 반환해야한다. 배열은 길이가 1 이상부터 무조건 가변이다.

모든 작업에서 되도록 [불변 객체](../../chapter04%20클래스와%20인터페이스/item17%20변경%20가능성을%20최소화하라/README.md)들을 조합하여 객체를 구성해야 방어적 복사를 할일이 줄어든다는 것을 알 수 있다. 방어적 복사는 성능 저하가 따르고, 항상 쓸수 있는 것도 아니다. 호출자가 컴포넌트 내부를 수정하지 않으리라 확신한다면 방어적 복사를 생략할 수 있다. (이 상황이라도 주석으로 문서화하는게 좋다.)

방어적 복사를 생략해도 되는 상황은 해당 클래스와 그 클라이언트가 상호 신뢰할 수 있을 때, 혹은 불변식이 깨지더라도 그 영향이 오직 호출한 클라이언트로 국한될 때로 한정지어야한다.

## 정리

클라이언트로 받거나 반환하는 구성요소가 가변이라면 해당 요소는 반드시 방어적으로 복사해야 한다. 복사 비용이 크거나, 잘못 수정할 일이 없음을 신뢰한다면 해당 구성요소에 대한 책임이 클라이언트에게 있음을 문서로 명시한다.
