# ✨ 아이템 17: 변경 가능성을 최소화하라

불변 클래스란 그 인스턴스의 내부 값을 수정할 수 없는 객체이다. 인스턴스화 된 상태에서 객체가 파괴될 때까지 절대 달라지지않는다. `String`, `BigInteger` 그리고 `BigDecimal` 자바 진영에서 불변 클래스 중 하나이다.

불변 클래스는 가변 클래스보다 설계하고 구현하는데 사용하기 쉬우며, 오류가 생길 여지도 적고 안전해진다.

- 객체 상태를 변경하는 메소드를 제공하지 않는다.
- 클래스를 확장할 수 없도록 한다. (대표적인 방법은 final 로 클래스를 만드는 것)
- 모든 필드를 final 로 선언한다. (새로 생성된 인스턴스를 동기화없이 다른 스레드에 건네도 동작하게끔 보장해야 함)
- 모든 필드를 private 로 선언한다. (기본 타입 필드나 불변 객체를 참조하는 필드를 public final 로 선언해도 불변 객체가 되지만 다음 릴리즈에서 내부 표현을 변경할 수 없음)
- 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다. (클래스 내부에서 가변 객체를 참조하는 필드가 있으면 클라이언트가 해당 참조를 얻지 못하도록 해야하며, 필요하다면 방어적 복사를 수행해야 함)

```java
public final class Complex {
// ...

    public Complex plus(Complex c) {
        return new Complex(re + c.re, im + c.im);
    }

// ...
}
```

인스턴스 자신은 수정하지 않고 새로운 Complex 인스턴스를 만들어 반환하는 방법에 주목하자. 피연산자에 함수를 적용하여 그 결과를 반환하지만, 피연산자 자체는 그대로인 프로그래밍 패턴을 함수형 프로그래밍이라고 한다. 반대인 명령형 프로그래밍은 자신을 수정하여 자신의 상태가 변하게 된다. 동사(add) 대신 전치사(plus) 를 사용한 것도 해당 메소드가 값을 변경하지 않는다는 사실을 강조하려는 의도이다.

- 불변은 단순하며 근본적으로 스레드에 안전하여 따로 동기화가 필요가 없다. 또한 안심하고 공유할 수 있다. 자주 사용하는 인스턴스를 캐싱하여 같은 인스턴스를 중복 생성하지 않는 정적 팩토리를 제공할 수 있으며, 설계할 때부터 큰 수고 없이 캐시 기능을 덧붙일 수 있다.
- 앞서 자유롭게 공유할 수 있다는 점은 방어적 복사가 필요없다는 것이며, (복사해봐야 똑같은 원본이다.) clone 메소드를 제공할 필요가 없다. 불변 객체는 자유롭게 불변 객체끼리는 내부 데이터를 공유해도 무방하다.
- 객체를 만들때 다른 불변 객체를 구성요소로 사용하면 이점이 있다. 구조가 복합하더라도 불변식을 유지하기 쉽기 때문이다.
- 불변 객체는 그 자체로 실패 원자성을 제공한다. 상태가 절대로 변하지 않으니, 잠깐이라도 불일치 상태에 빠질 가능성이 없다.
- 단점은 값이 다르다면 반드시 독립된 객체를 만들어야한다는 것이다. 값에 대한 가짓수가 많다면 모두 만드는 데 큰 비용을 치뤄야 한다. 원하는 객체를 완성하기까지의 단계가 많고, 그 중간 단계에서 만들어진 객체들이 모두 버려진다면 성능 문제는 더욱 커진다. 이를 대처하는 방법은 다단계 연산들을 예층하여 기본 기능으로 제공하는 것과 연산 속도를 높여주는 가변 동반 클래스를 만드는 것이다. (후자는 구현난이도가 어렵다.)

## public 정적 팩토리 제공

```java
private Complex(double re, double im) {
    this.re = re;
    this.im = im;
}

public static Complex valueOf(double re, double im) {
    return new Complex(re, im);
}
```

## 정리

이번 아이템을 종합하면 합당한 이유가 없다면 모든 필드는 private final 이어야 한다. 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 객체를 생성해야 한다.
