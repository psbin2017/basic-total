# Configuration

## 용량

1. 메시지 사이즈
2. 초당 메시지 수
3. 보관일자 (`log.retention.ms`, `log.retention.minutes`, `log.retention.hours` 순으로 오버라이드 됨)
4. 토픽의 개수
5. 리플리카 대수

가장 만만한 조정 방법은 보관일자를 조정하는 것이다. `log.retention.bytes` 는 보관 최대 크기인데 보관일자 설정 프로퍼티와 같이 있는 경우 하나의 조건이 충족 될 때 메시지가 삭제된다.

### 계산 방법 예제

- 메시지 사이즈: 1KB
- 초당 메시지 수: 1,000 개
- 보관일자: 10 일
- 토픽의 개수 10 개
- 리플리카 3 대

```text
1 KB        * 1000 개       = 초당 1MB
1 MB        * 60 초         = 분당 60MB
60 MB       * 60 분         = 시간당 3.6GB
3.6 GB      * 24 시간       = 일당 86.4GB
86.4 GB     * 10 일         = 10 일 864 GB
864 GB      * 10 토픽       = 10 토픽 8640 GB
8640 GB     * 3 리플리카    = 3 리플리카 약 26 TB
```

## 프로듀서

- Serializer : 메시지를 바이트 배열로 변환
- Partitioner : 어떤 파티션으로 저장할지 결정
- Buffer (Batch) : 메시지를 배치에 담음
- Sender : 메시지를 전송함

### `ACKS`

`ACKS` 는 데이터의 안정성과 속도의 영향을 미친다.

0: 자신이 보낸 메시지 확인 안함
1: 자신이 보낸 메시지를 리더에게서만 확인함.
ALL (-1) : 자신이 보낸 메시지를 리더/팔로워까지 확인함.

### `batch.size`

센더가 전송시 배치의 크기를 조정할 수 있다. 메시지 사이즈 보다 배치 사이즈가 작으면 안되고, 반드시 배치 사이즈보다 커야한다.

평균 메시지 사이즈를 계산하여 배치 사이즈에 쌓일 수 있는 최대 크기를 계산할 수 있다.

### `linger.ms`

배치에 적재되기 전 데이터를 기다리는 대기 시간이다. 기본 값은 0 으로 바로 전송한다. 앞서 본 `batch.size` 를 조절해도 기본 값으로 설정되어 있으면 바로 바로 전송하게 된다.

`linger.ms` 으로 지정된 시간이전에 `batch.size` 가 차게 되면 설정 시간을 무시하고 바로 전송한다.

## 컨슈머

컨슈머는 파티션의 숫자의 비율을 맞추는 것이 좋다. 파티션을 같은 컨슈머 그룹에서 공유할 수 없다. (애초에 말이 안되는 구조가 된다.)

### `auto-offset-reset`

카프카에서 컨슈머를 새로 생성하여 토픽에서 데이터를 가지고 오기 위해서 필요한 옵션.

- `latest` (default) : 가장 마지막 offset 부터 컨슈밍
- `earliest` : 가장 빠른 offset 부터 컨슈밍
- `none` : offset 이 없다면 Exception 발생

## 참고한 내용

- [카프카 설치 시 가장 중요한 설정 4가지](https://brunch.co.kr/@peter5236/13)
- [카프카 핵심가이드 -2](https://cykei.tistory.com/104)
- [대규모 데이터의 카프카 프로듀서 성능 향상 방법](https://blog.voidmainvoid.net/475)
